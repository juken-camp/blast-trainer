<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>BLAST TRAINER</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
  <style>
    html,body{margin:0;height:100%;font-family:"Segoe UI",sans-serif;
      background:#111;color:#fff;display:flex;flex-direction:column;
      justify-content:center;align-items:center}
    #game{max-width:540px;width:94vw;text-align:center}
    h1{margin:0 0 6px;font-size:2rem;color:#ffeb3b;
      text-shadow:0 0 8px #ff0}
    #jp{font-size:1.4rem;margin:14px 0 18px;min-height:2.6rem}
    .opt{width:100%;padding:12px 0;margin:6px 0;font-size:1.1rem;
      border:none;border-radius:10px;background:#434343;color:#fff;
      transition:transform .15s}
    .opt:active{transform:scale(.96)}
    .correct{background:#00c853!important}
    .wrong{background:#d50000!important}
    #hud{display:flex;justify-content:space-between;
      margin-top:12px;font-size:1.05rem}
    #startBtn{padding:12px 28px;border:none;border-radius:12px;
      background:#2962ff;color:#fff;font-size:1.1rem;margin-top:22px}
    #levelSel,#timerSel{margin-top:10px;display:flex;
      gap:6px;justify-content:center;flex-wrap:wrap}
    .btnSel{padding:6px 14px;border:none;border-radius:8px;
      background:#555;color:#fff;font-size:.85rem;cursor:pointer}
    .sel{background:#00bcd4!important}
    #info{margin-top:10px;min-height:1.4rem;
      color:#ffb74d;font-weight:bold}
  </style>
</head>
<body>
  <div id="game">
    <h1>BLAST TRAINER</h1>
    <div id="jp">レベルと時間を選んで START</div>

    <!-- レベル選択 -->
    <div id="levelSel">
      <button class="btnSel sel" data-lv="5">英検5級</button>
      <button class="btnSel"      data-lv="4">4級</button>
      <button class="btnSel"      data-lv="3">3級</button>
      <button class="btnSel"      data-lv="p2">準2</button>
      <button class="btnSel"      data-lv="2">2級</button>
      <button class="btnSel"      data-lv="p1">準1</button>
      <button class="btnSel"      data-lv="1">1級</button>
    </div>

    <!-- タイマー選択 -->
    <div id="timerSel">
      <button class="btnSel sel" data-sec="60">1分</button>
      <button class="btnSel"     data-sec="180">3分</button>
      <button class="btnSel"     data-sec="300">5分</button>
      <button class="btnSel"     data-sec="600">10分</button>
      <button class="btnSel"     data-sec="0">無制限</button>
    </div>

    <div id="opts"></div>
    <button id="startBtn">START</button>
    <div id="hud" style="display:none">
      <span id="timer">∞</span>
      <span id="score">0</span>
    </div>
    <div id="info"></div>
  </div>

  <script>
  /* -------------------- 設定 -------------------- */
  const DATA_PATH = "data";  // JSON ファイルが置いてあるフォルダ
  let selLv="5", timerMax=0;
  let words=[], pool=[], timer=0, score=0, current=null, running=false;

  const jpEl     = document.getElementById("jp"),
        optsDiv  = document.getElementById("opts"),
        timerEl  = document.getElementById("timer"),
        scoreEl  = document.getElementById("score"),
        hud      = document.getElementById("hud"),
        startBtn = document.getElementById("startBtn"),
        info     = document.getElementById("info");

  /* -------- ボタン選択ユーティリティ -------- */
  function setSel(groupSelector, value) {
    document.querySelectorAll(groupSelector).forEach(b => {
      const key = groupSelector === "#levelSel .btnSel" ? b.dataset.lv : b.dataset.sec;
      b.classList.toggle("sel", String(key) === String(value));
    });
  }

  /* レベル選択 */
  document.querySelectorAll('#levelSel .btnSel').forEach(b => {
    b.onclick = () => {
      selLv = b.dataset.lv;
      setSel('#levelSel .btnSel', selLv);
      jpEl.textContent = `レベル: 英検${selLv.replace("p","準")} を選択`;
    };
  });

  /* タイマー選択 */
  document.querySelectorAll('#timerSel .btnSel').forEach(b => {
    b.onclick = () => {
      timerMax = Number(b.dataset.sec);
      setSel('#timerSel .btnSel', timerMax);
      jpEl.textContent = timerMax
        ? `制限 ${(timerMax/60)||1} 分`
        : '無制限 を選択';
    };
  });

  /* ヘルパー */
  const shuffle = a => {
    for (let i = a.length-1; i > 0; i--) {
      const j = Math.floor(Math.random()*(i+1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  };
  const speak = txt => {
    if (!('speechSynthesis' in window)) return;
    speechSynthesis.speak(Object.assign(
      new SpeechSynthesisUtterance(txt),{lang:'en-US'}
    ));
  };
  function refillPool() { pool = shuffle([...words]); }

  /* データ読み込み */
  async function loadData() {
    const file = `${DATA_PATH}/words-${selLv}.json`;
    try {
      const res = await fetch(file);
      words = await res.json();
    } catch (e) {
      words = [{en:'sample',jp:'サンプル'}];
    }
    refillPool();
  }

  /* ゲームロジック */
  function nextQuestion() {
    if (!running) return;
    info.textContent = "";
    optsDiv.innerHTML = "";
    if (pool.length === 0) refillPool();
    current = pool.pop();
    jpEl.textContent = current.jp;
    const choices = shuffle([
      current,
      ...shuffle(words.filter(w => w.en !== current.en)).slice(0,3)
    ]);
    choices.forEach(c => {
      const btn = document.createElement("button");
      btn.className = "opt";
      btn.textContent = c.en;
      btn.onclick = () => answer(btn,c);
      optsDiv.appendChild(btn);
    });
  }

  function answer(btn, choice) {
    if (!running) return;
    speak(choice.en);
    const ok = choice.en === current.en;
    if (ok) {
      btn.classList.add("correct");
      score++;
      scoreEl.textContent = score;
      anime({targets:btn,scale:[1,1.12,1],duration:300});
      setTimeout(nextQuestion, 380);
    } else {
      btn.classList.add("wrong");
      anime({targets:btn,translateX:[0,12,-12,8,-8,0],duration:350});
      info.textContent = `${choice.en} = ${choice.jp}`;
    }
  }

  function finish() {
    running = false;
    jpEl.textContent = "TIME UP!";
    optsDiv.innerHTML = "";
    startBtn.textContent = "RESTART";
    startBtn.style.display = "inline-block";
  }

  async function startGame() {
    await loadData();
    running = true;
    score = 0;
    scoreEl.textContent = 0;
    timer = timerMax;
    timerEl.textContent = timerMax ? timerMax : '∞';
    startBtn.style.display = "none";
    hud.style.display = "flex";
    nextQuestion();
    if (timerMax) {
      const t = setInterval(() => {
        if (!running) { clearInterval(t); return; }
        timer--;
        timerEl.textContent = timer;
        if (timer <= 0) {
          finish();
          clearInterval(t);
        }
      }, 1000);
    }
  }

  startBtn.onclick = startGame;
  </script>
</body>
</html>
