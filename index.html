<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BLAST TRAINER</title>

  <!-- ========== CSS（前回と同じ） ========== -->
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Arial',sans-serif;background:linear-gradient(135deg,#1e3c72,#2a5298);
         color:#fff;min-height:100vh;display:flex;flex-direction:column;align-items:center;
         justify-content:center;padding:20px;}
    .container{max-width:800px;width:100%;text-align:center;}
    h1{font-size:3em;color:#ffd700;text-shadow:2px 2px 4px rgba(0,0,0,.5);margin-bottom:40px;
        font-weight:bold;letter-spacing:2px;cursor:pointer;}
    .setup-screen{display:block}.game-screen,.result-screen{display:none}
    .progress-bar{width:100%;height:10px;background:rgba(255,255,255,.2);border-radius:5px;
                  margin-bottom:30px;overflow:hidden;}
    .progress-fill{height:100%;background:linear-gradient(90deg,#4CAF50,#45a049);
                   width:0%;transition:width .3s;}
    .level-selection,.timer-selection{margin-bottom:30px;}
    .level-buttons,.timer-buttons{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;
                                  margin-bottom:20px;}
    .level-btn,.timer-btn{padding:12px 20px;border:none;border-radius:25px;
                          background:rgba(255,255,255,.2);color:#fff;cursor:pointer;
                          font-size:16px;font-weight:bold;transition:.3s;
                          backdrop-filter:blur(10px);}
    .level-btn:hover,.timer-btn:hover{background:rgba(255,255,255,.3);transform:translateY(-2px);}
    .level-btn.selected,.timer-btn.selected{background:#00bcd4;box-shadow:0 4px 15px rgba(0,188,212,.4);}
    .start-btn{padding:15px 40px;font-size:20px;background:linear-gradient(45deg,#4CAF50,#45a049);
               border:none;border-radius:30px;color:#fff;cursor:pointer;font-weight:bold;
               transition:.3s;box-shadow:0 4px 15px rgba(76,175,80,.4);}
    .start-btn:hover{transform:translateY(-3px);box-shadow:0 6px 20px rgba(76,175,80,.6);}
    .start-btn:disabled{background:rgba(255,255,255,.3);cursor:not-allowed;transform:none;box-shadow:none;}
    .game-info{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;
               font-size:18px;font-weight:bold;}
    .timer{color:#ffd700}.score{color:#4CAF50}
    .word-display{background:rgba(255,255,255,.1);border-radius:20px;padding:40px;margin-bottom:30px;
                  backdrop-filter:blur(10px);border:2px solid rgba(255,255,255,.2);}
    .word{font-size:3em;font-weight:bold;color:#ffd700;text-shadow:2px 2px 4px rgba(0,0,0,.5);
          margin-bottom:20px;}
    .choices{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:30px;}
    .choice-btn{padding:20px;font-size:18px;border:none;border-radius:15px;
                background:rgba(255,255,255,.2);color:#fff;cursor:pointer;transition:.3s;
                backdrop-filter:blur(10px);border:2px solid rgba(255,255,255,.3);font-weight:bold;}
    .choice-btn:hover:not(:disabled){background:rgba(255,255,255,.3);transform:translateY(-2px);}
    .choice-btn.correct{background:linear-gradient(45deg,#4CAF50,#45a049);border-color:#4CAF50;}
    .choice-btn.incorrect{background:linear-gradient(45deg,#f44336,#d32f2f);border-color:#f44336;}
    .answer-display{margin-top:20px;padding:15px;background:rgba(0,0,0,.3);border-radius:10px;
                    font-size:18px;font-weight:bold;color:#ffd700;}
    .final-score{font-size:4em;color:#ffd700;margin-bottom:20px;}
    .restart-btn{padding:15px 40px;font-size:20px;background:linear-gradient(45deg,#2196F3,#1976D2);
                 border:none;border-radius:30px;color:#fff;cursor:pointer;font-weight:bold;
                 transition:.3s;box-shadow:0 4px 15px rgba(33,150,243,.4);margin-top:20px;}
    .restart-btn:hover{transform:translateY(-3px);box-shadow:0 6px 20px rgba(33,150,243,.6);}
    @media(max-width:768px){h1{font-size:2em}.word{font-size:2em}.choices{grid-template-columns:1fr}
                            .level-buttons,.timer-buttons{flex-direction:column;align-items:center}}
  </style>
</head>

<body>
  <div class="container">
    <h1 id="title">BLAST TRAINER</h1>

    <!-- セットアップ -->
    <div class="setup-screen" id="setupScreen">
      <div class="level-selection">
        <h2 style="margin-bottom:20px;">級を選択</h2>
        <div class="level-buttons">
          <button class="level-btn" data-level="5">英検5級</button>
          <button class="level-btn" data-level="4">4級</button>
          <button class="level-btn" data-level="3">3級</button>
          <button class="level-btn" data-level="p2">準2級</button>
          <button class="level-btn" data-level="2">2級</button>
          <button class="level-btn" data-level="p1">準1級</button>
          <button class="level-btn" data-level="1">1級</button>
        </div>
      </div>

      <div class="timer-selection">
        <h2 style="margin-bottom:20px;">時間制限</h2>
        <div class="timer-buttons">
          <button class="timer-btn" data-time="60">1分</button>
          <button class="timer-btn" data-time="180">3分</button>
          <button class="timer-btn" data-time="300">5分</button>
          <button class="timer-btn" data-time="600">10分</button>
          <button class="timer-btn" data-time="0">無制限</button>
        </div>
      </div>

      <button class="start-btn" id="startBtn" disabled>ゲーム開始</button>
    </div>

    <!-- ゲーム画面 -->
    <div class="game-screen" id="gameScreen">
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>

      <div class="game-info">
        <div class="timer" id="timerDisplay">時間: --</div>
        <div class="score" id="scoreDisplay">スコア: 0/0</div>
      </div>

      <div class="word-display">
        <div class="word" id="currentWord">Loading...</div>
        <div class="answer-display" id="answerDisplay" style="display:none;"></div>
      </div>

      <div class="choices" id="choices"></div>
    </div>

    <!-- 結果画面 -->
    <div class="result-screen" id="resultScreen">
      <h2>ゲーム終了！</h2>
      <div class="final-score" id="finalScore">0/0</div>
      <div id="finalMessage">お疲れ様でした！</div>
      <button class="restart-btn" id="restartBtn">もう一度プレイ</button>
    </div>
  </div>

  <!-- ========== JavaScript ========== -->
  <script>
    /******** ユーティリティ ********/
    const shuffle = arr => {
      for(let i=arr.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return arr;
    };
    const sampleRandom = (arr,n) => shuffle(arr.slice()).slice(0,n);

    /******** メインクラス ********/
    class BlastTrainer{
      constructor(){
        /* 状態 */
        this.level=null;            // 5,4,3,p2,2,p1,1
        this.limitTime=null;        // 秒数 (0=無制限)
        this.words=[];              // {english, japanese}[]
        this.queue=[];              // シャッフル済み出題リスト
        this.index=0;               // 現在位置
        this.score=0;
        this.attempts=0;
        this.timeLeft=0;
        this.timerId=null;
        this.playing=false;

        /* イベント */
        document.getElementById('title').addEventListener('click',()=>location.reload());
        document.querySelectorAll('.level-btn').forEach(b=>b.addEventListener('click',()=>this.setLevel(b)));
        document.querySelectorAll('.timer-btn').forEach(b=>b.addEventListener('click',()=>this.setTime(b)));
        document.getElementById('startBtn').addEventListener('click',()=>this.startGame());
        document.getElementById('restartBtn').addEventListener('click',()=>this.restart());
      }

      setLevel(btn){
        document.querySelectorAll('.level-btn').forEach(b=>b.classList.remove('selected'));
        btn.classList.add('selected');
        this.level=btn.dataset.level;
        this.toggleStart();
      }
      setTime(btn){
        document.querySelectorAll('.timer-btn').forEach(b=>b.classList.remove('selected'));
        btn.classList.add('selected');
        this.limitTime=parseInt(btn.dataset.time,10);
        this.toggleStart();
      }
      toggleStart(){
        document.getElementById('startBtn').disabled = !(this.level && this.limitTime!==null);
      }

      /***** 単語ロード *****/
      async loadWords(){
        try{
          const res=await fetch(`data/words-${this.level}.txt`);
          if(!res.ok) throw new Error('fetch failed');
          const txt=await res.text();
          this.words = txt.trim().split('\n').map(l=>{
            const [en,ja]=l.split('\t');
            return {english:en.trim(), japanese:ja.trim()};
          }).filter(w=>w.english&&w.japanese);
          if(!this.words.length) throw new Error('no words');
        }catch(e){
          /* フォールバック */
          console.warn('words file 読み込み失敗。サンプル語彙を使用します。');
          const fallback = Array.from({length:50},(_,i)=>({
            english:`sample${i+1}`,
            japanese:`サンプル${i+1}`
          }));
          this.words=fallback;
        }
      }

      /***** ゲーム開始 *****/
      async startGame(){
        document.getElementById('setupScreen').style.display='none';
        document.getElementById('gameScreen').style.display='block';

        await this.loadWords();
        this.queue = shuffle(this.words.slice()); // 出題順を一度決める
        this.index = 0;
        this.score = 0;
        this.attempts = 0;
        this.playing = true;

        this.timeLeft=this.limitTime;
        if(this.limitTime>0) this.startTimer();
        else this.updateTimerText();

        this.showQuestion();
      }

      /***** タイマー *****/
      startTimer(){
        this.updateTimerText();
        this.timerId=setInterval(()=>{
          this.timeLeft--;
          this.updateTimerText();
          if(this.timeLeft<=0) this.endGame();
        },1000);
      }
      updateTimerText(){
        const el=document.getElementById('timerDisplay');
        if(this.limitTime===0){ el.textContent='時間: 無制限'; return;}
        const m=Math.floor(this.timeLeft/60);
        const s=(this.timeLeft%60).toString().padStart(2,'0');
        el.textContent=`時間: ${m}:${s}`;
      }

      /***** 出題 *****/
      showQuestion(){
        if(!this.playing) return;

        if(this.index>=this.queue.length){
          /* 全語消化→再シャッフル */
          shuffle(this.queue);
          this.index=0;
        }
        this.current=this.queue[this.index++];
        document.getElementById('currentWord').textContent=this.current.english;

        const ansEl=document.getElementById('answerDisplay');
        ansEl.style.display='none';
        ansEl.textContent='';

        /* 選択肢作成 */
        const pool=this.words.filter(w=>w.japanese!==this.current.japanese);
        const wrongs=sampleRandom(pool,3).map(w=>w.japanese);
        const choices=shuffle([this.current.japanese,...wrongs]);

        const box=document.getElementById('choices');
        box.innerHTML='';
        choices.forEach(ja=>{
          const btn=document.createElement('button');
          btn.className='choice-btn';
          btn.textContent=ja;
          btn.addEventListener('click',()=>this.checkAnswer(btn,ja));
          box.appendChild(btn);
        });

        this.updateScoreBar();
      }

      /***** 判定 *****/
      checkAnswer(btn,selectedJa){
        if(!this.playing) return;

        const correctJa=this.current.japanese;
        const selectedObj=this.words.find(w=>w.japanese===selectedJa);
        const isCorrect = selectedJa===correctJa;
        this.attempts++;

        /* 音声 */
        if(isCorrect){ this.speak(this.current.english);}
        else if(selectedObj){ this.speak(selectedObj.english);}

        if(isCorrect){
          this.score++;
          btn.classList.add('correct');
          this.showFeedback(`正解！ ${this.current.english} = ${correctJa}`,true);

          document.querySelectorAll('.choice-btn').forEach(b=>b.disabled=true);
          setTimeout(()=>this.showQuestion(),1000);
        }else{
          btn.classList.add('incorrect');
          btn.disabled=true;
          this.showFeedback(`あなたの回答: ${selectedObj.english} = ${selectedJa} ✖`,false);
        }

        this.updateScoreBar();
      }

      showFeedback(msg,ok){
        const el=document.getElementById('answerDisplay');
        el.textContent=msg;
        el.style.display='block';
        el.style.color = ok ? '#4CAF50' : '#ffd700';
      }

      speak(word){
        if('speechSynthesis' in window){
          const ut=new SpeechSynthesisUtterance(word);
          ut.lang='en-US';
          ut.rate=0.8;
          speechSynthesis.speak(ut);
        }
      }

      updateScoreBar(){
        document.getElementById('scoreDisplay').textContent=`スコア: ${this.score}/${this.attempts}`;
        const pct=this.attempts?this.score/this.attempts*100:0;
        document.getElementById('progressFill').style.width=pct+'%';
      }

      /***** 終了 *****/
      endGame(){
        this.playing=false;
        if(this.timerId) clearInterval(this.timerId);

        document.getElementById('gameScreen').style.display='none';
        document.getElementById('resultScreen').style.display='block';

        const pct=this.attempts?Math.round(this.score/this.attempts*100):0;
        document.getElementById('finalScore').textContent=`${this.score}/${this.attempts} (${pct}%)`;

        const msg = pct>=90 ? '素晴らしい！完璧に近い成績です！' :
                    pct>=70 ? 'とても良い成績です！' :
                    pct>=50 ? '良い調子です！もう少し頑張りましょう！' :
                              '練習を重ねて頑張りましょう！';
        document.getElementById('finalMessage').textContent=msg;
      }

      /***** リスタート *****/
      restart(){
        if(this.timerId) clearInterval(this.timerId);
        document.getElementById('resultScreen').style.display='none';
        document.getElementById('setupScreen').style.display='block';
        document.querySelectorAll('.level-btn,.timer-btn').forEach(b=>b.classList.remove('selected'));
        document.getElementById('progressFill').style.width='0%';
        document.getElementById('startBtn').disabled=true;
        /* 状態リセット */
        this.level=null; this.limitTime=null;
      }
    }

    /* インスタンス生成 */
    new BlastTrainer();
  </script>
</body>
</html>